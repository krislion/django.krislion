<!DOCTYPE html>
<html>
<head>
 <meta charset="UTF-8"/>
 <title>Kris Lion - chat</title>
 <style type="text/css">
  #input { position: absolute; width: 45%; left: 50%; }
  #content { width: 95%; }
  #message { position: absolute; top: 0; width: 45%; height: 100%; word-wrap: break-word; word-break: break-all; overflow:scroll; }
  .top1em { margin-top: 1em; }
  .top2em { margin-top: 2em; }
 </style>
 <script src="/_ah/channel/jsapi"></script>
 <script>goog.appengine.Socket.POLLING_TIMEOUT_MS = 1200;</script>
 <script src="/jquery.js"></script>
 <script>
  $(document).ready(
   function() {
    var $content = $('#content');
    var $message = $('#message');
    var token;

    function get_token() {
     $.get('/get_token', function(data){
      if (data) {
       token = data;
       openChannel();
      } else {
       $message.append('<p>Sorry, this chat room has reached the capacity of anonymous users, you need <a href="/login">login</a> to join them.</p>');
      }
     });
    }
    get_token();

    function onOpen() {
     $.post('/open', {'token': token, 'csrfmiddlewaretoken':'{{ csrfmiddlewaretoken_token }}'});
    }

    function onMessage(m) {
     var message = $.parseJSON(m.data);
     message = message.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
     var d = new Date();
     var timing = ('0'+d.getHours()).slice(-2) + ":" + ('0'+d.getMinutes()).slice(-2) + ':' + ('0'+d.getSeconds()).slice(-2);
     $message.append('<blockquote><pre><span>' + timing + "</span>-&gt;" + message + '</pre></blockquote>');
    }

    function openChannel() {
     var channel = new goog.appengine.Channel(token);
     var handler = {
       'onopen': onOpen,
       'onmessage': onMessage,
       'onerror': function() {},
       'onclose': function() {$message.append('<p>Your session has expired, you can refresh this page to join the chat room again.</p>');} // you can reopen the channel here if token has expired
     };
     channel.open(handler);
    }

    function submit() {
     if (token) {
      $.ajax({
       url: '/post_msg',
       type: 'POST',
       data: {'token': token, 'content': $content.val(), 'csrfmiddlewaretoken':'{{ csrfmiddlewaretoken_token }}'}
      });
      $content.val('').focus();
     }
    }

    $content.keypress(function(e) {
     if (e.shiftKey && e.keyCode == 13) {
      submit();
      return false;
     }
    });
    $('#submit_message').click(submit);

    $(window).bind('beforeunload', function() {
     if (token)
      $.post('/del_token', {'token': token, 'csrfmiddlewaretoken':'{{ csrfmiddlewaretoken_token }}'});
    })
   }
  );
 </script>
</head>
<body>
 <div id="input">
  <div><textarea id="content" rows="3" cols="60"></textarea></div>
  <div class="top1em"><input type="button" value="Send" id="submit_message"/> <a href="/login">{{ login_logout_prompt }}</a></div>
  <div class="top2em"><blockquote><p>You can press <strong>Shift+Enter</strong> to submit a message.</p></blockquote></div>
 </div>
 <div id="message"></div>
 {% include "ga.html" %}
</body>
</html>

